---
title: "Crime Data Mapping Using R Spatial"
output: html_notebook
---

Tutorial on reading in data and creating some basic maps in the simple features package. The first step here is to load in some packages. 

```{r setup}
library(sf)
library(dplyr)
library(readr)
library(ggplot2)
library(mapview)
library(raster)
library(lubridate)

# set directory from which we read in data
ddir <- "C:/Users/Yixin Sun/Documents/Dropbox/Recruiting/2018 Recruiting/epic_orientation/data/Spatial_Exercise"

# function that creates custom map style for ggplot
theme_nothing <- function(base_size = 12, title_size = 15){
  return(
    theme(panel.grid.major = element_line(colour = "transparent"), 
          panel.grid.minor = element_line(colour = "transparent"),
          panel.background = element_blank(), axis.line = element_blank(), 
          axis.text.x = element_blank(),
          axis.text.y = element_blank(), 
          axis.title = element_blank(), 
          axis.ticks = element_blank(),
          plot.title = element_text(size = title_size, hjust = 0.5), 
          plot.caption = element_text(size = 6))) 
}

```

# Converting CSV to `sf` Object
Often times with point objects, the data comes in a table of latitude and longitude, which we coerce into a spatial object. The important thing here is to know which coordinate reference system we are using. 

```{r convert csv, include = T}
utm_crs <- 27700

# load data in and get rid of spaces in column names
streetCrime <- 
  read_csv(file.path(ddir, "2012-03-cumbria-street.csv")) %>%
  rename(Report_by = `Reported by`, 
         Falls_within = `Falls within`, 
         Crime_type = `Crime type`)
glimpse(streetCrime)

streetCrime <-
  streetCrime %>%
  st_as_sf(coords = c("Easting", "Northing"), crs = utm_crs)

glimpse(streetCrime)
```

# Exploratory Plotting

There are several ways to visualize data - base R, `mapview`, or `ggplot2`. Since `mapview` will overlay your data on a global map, it is a good way to visualize if you have the right coordinate reference system. 

```{r plotting options}
plot(streetCrime$geometry)

mapview(streetCrime, map.types = ) # REMEMBER TO LOOK UP MAP.TYPES WHEN THERE'S INTERNET

streetCrime %>%
  ggplot() + 
  geom_sf(aes(colour = Crime_type)) + 
  ggtitle("Street Crime By Type") + 
  theme_nothing()

```

# Police Neighbourhood Areas
UK Crime is organized by neighborhoods. Here, we read in the shapefile of the neighborhoods and aggregate the point data to the neighborhood level. 
Important to note that the neighborhood polygons are in longitude/latitude while the crime data is in UTM, so we must first convert the data to the same CRS

```{r neighbourhood shapefile}
nh <- 
  file.path(ddir, "neighbourhoods.shp") %>%
  st_read(stringsAsFactors = F) %>%
  st_transform(utm_crs)
  
nh %>%
  ggplot() + 
  geom_sf() +
  geom_sf(data = streetCrime) + 
  ggtitle("Neighbourhood Polygons") + 
  theme_minimal()

# Join crime data to neighbourhood polyogns
# aggregate total crime in each neighbourhood 
nh_crime <-
  nh %>%
  st_join(streetCrime) %>% 
  group_by(ID, Name, Population) %>%
  summarise(total_crimes = n()) %>%
  mutate(crime_per_capita = total_crimes / Population)

# plot chloropleth map - ARRANGE 2 PLOTS SIDE BY SIDE FOR LEVELS AND THEN PER CAPITA
nh_crime %>%
  ggplot() +
  geom_sf(aes(fill = crime_per_capita)) + 
  theme_nothing() + 
  ggtitle("Crime in Neighbourhoods")

```

# Land Use Raster Data
Some neighbourhoods are clearly more rural than others. Therefore, it might be useful to visualize the land types the analysis region. Here, we learn how to read in and extract information from a raster file. 

Raster files store information for each pixel. In this case, we have a land use classification at each pixel level. What we want to do is for each neighbourhood polygon, count up the number of pixels in that polygon that fall within each land use classification.

```{r}
# read in legend for land use raster file
legend <- 
  file.path(ddir, "legend.csv") %>%
  read_csv()
head(legend)

# read in raster file
landUse <- raster(file.path(ddir, "cumbriaLandUse.tif"))
plot(landUse)

# function for counting up land use classification in a polygon
# then return the classification that had the highest area coverage
lc_extract <- function(p){
  lc_temp <- 
    as_tibble(p) %>%
    filter(value != 0) %>%
    left_join(legend, by = c("value" = "GRID_CODE")) %>%
    group_by(LABEL2) %>%
    summarise(n = n()) %>%
    arrange(-n) %>%
    filter(row_number() == 1) %>%
    dplyr::select(Classification = LABEL2) %>%
    ungroup

  return(lc_temp)
}

# note that extract currently only works with `sp` objects, so we first 
# transform nh to an `sp` object
nh_sp <- as(nh, "Spatial")
lu_crime <- 
  extract(landUse, as(nh, "Spatial")) %>%
  map_df(lc_extract) %>%
  bind_cols(nh_crime, .)

# FIGURE OUT WHICH SHAPE IS THE ADDITION SIGN AND USE THAT INSTEAD
# MAKE SIDE BY SIDE FIGURES HERE
# WRAP WORDS IN LEGEND
lu_crime %>%
  ggplot() +
  geom_sf(aes(fill = Classification)) + 
  theme_nothing() + 
  ggtitle("Land Use of Neighbourhoods") + 
  geom_sf(data = streetCrime, shape = 3)

```


# Crimes and Roads
Here we are interested in whether crimes are close to major roads, or if there are specific crimes that usually happen near roads. We load in road data, and find distance of crimes to roads. 


```{r crime and roads}
roads <- 
  file.path(ddir, "mainroads.shp") %>%
  st_read(stringsAsFactors = F) %>%
  st_transform(utm_crs)

table(roads$type)

# keep just major roads
roads <- 
  roads %>%
  filter(type %in% c("motorway", "motorway_link", "trunk", "trunk_link", 
                     "primary", "primary_link"))

# Get distance to closest main road
streetCrime$dRoad <- 
  st_distance(streetCrime, roads) %>%
  apply(1, min)


streetCrime %>%
  ggplot(aes(x = Crime_type, y = dRoad))


```

# Crime over Time
We also have a data file of the crime counts in neighbourhoods for a number of month. The file has one for each month for each neighbourhood, and lists the number of crimes in each category. Here, we first join this with the neighbourhoods polygons and create some time series plots

```{r space-time data}
allCrime <-
  file.path(ddir, "allCrime.csv") %>%
  read_csv

glimpse(allCrime)

# right now month is in character format - coerce this into better format
# use lubridate package
allCrime <- mutate(allCrime, Month = ymd(paste0(Month, "-01")))
glimpse(allCrime)


# join with neighbourhoods too create a neigbourhoods-month panel
# note that a left_join preserves the class of the first argument, in this case
# it results in an sf dataframe
nh_all <-
  nh %>% 
  left_join(allCrime, by = c(ID = "Neighbourhood"))

# make sure neighbourhood-month is unique
nh_all %>% 
  group_by(ID, Month) %>%
  filter(n() > 1)

# plot just the first 4 months of all crimes
# FORMAT DATES INTO SEPTEMBER 2011 ETC  
# FIGURE OUT COLOR GRADIENTs
nh_all %>%
  filter(Month <= ymd(20111201)) %>%  
  ggplot(aes(fill = `All crime and ASB`)) +
  geom_sf() + 
  facet_wrap(~ Month) + 
  theme_minimal() + 
  scale_fill_gradient(low= "white", high = "red") +
  theme_nothing()

```

# Represent Data as GIF

```{r gganimate}

```



# Independent tasks

* Chloropleth map of all the violent crimes in each neighbourhood using all the data from `allCrime`
* Use two methods, mapping and line graph, to visualize how crime patterns have changed over time for just neighbourhoods GARZ01, GARZ02, GARZ03, GARZ04, and GARZ05
* Repeat exercise with roads, except this time, using bodies of water. The water shapefile path should be `file.path(ddir, "naturalwater.shp")`. 
